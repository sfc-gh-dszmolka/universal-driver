name: PEP-249 CI

on:
  push:
    branches: [ "main" ]
  pull_request:

concurrency:
  # older builds for the same pull request number or branch should be cancelled
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}

env:
  CARGO_TERM_COLOR: always
  PYTHON_REFERENCE_DRIVER_VERSION: "3.17.2"
  # Python version to run reference tests and comparison
  REFERENCE_PYTHON_VERSION: "3.13"
  # OS version for consistent naming across jobs
  REFERENCE_OS_VERSION: "ubuntu-latest"

jobs:
  # Build Rust core library once and share across Python jobs
  build_rust_core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update

      - name: Build Rust core library
        run: |
          RUSTFLAGS="" cargo build --package sf_core

      - name: Upload Rust artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rust-core-library
          path: target/debug/libsf_core.so

  # Combined unit + integration tests with universal connector
  pep249_tests:
    needs: build_rust_core
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        py: ["3.9", "3.10", "3.11", "3.12", "3.13"]
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.5.11"

      - name: Restore uv cache
        env:
          UV_CACHE_DIR: /tmp/.uv-cache
        uses: actions/cache@v4
        with:
          path: /tmp/.uv-cache
          key: uv-${{ runner.os }}-${{ matrix.py }}-${{ hashFiles('pep249_dbapi/uv.lock', 'pep249_dbapi/pyproject.toml', 'pep249_dbapi/tox.ini') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ matrix.py }}-
            uv-${{ runner.os }}-

      - name: Set up Python ${{ matrix.py }}
        run: uv python install ${{ matrix.py }}

      - name: Download Rust artifacts
        uses: actions/download-artifact@v4
        with:
          name: rust-core-library
          path: target/debug/

      - name: Decode secrets
        run: ./scripts/decode_secrets.sh
        env:
          PARAMETERS_SECRET: ${{ secrets.PARAMETERS_SECRET }}

      - name: Setup dependencies
        run: make setup
        working-directory: pep249_dbapi

      - name: Run all tests with coverage
        env:
          CORE_PATH: ${{ github.workspace }}/target/debug/libsf_core.so
          PARAMETER_PATH: ${{ github.workspace }}/parameters.json
          REFERENCE_DRIVER_VERSION: ${{ env.PYTHON_REFERENCE_DRIVER_VERSION }}
        run: |
          mkdir -p reports
          PYTHON_ID="${{ matrix.py }}"
          PYTHON_ID=${PYTHON_ID//./}  # Remove dots: 3.9 -> 39
          uv run tox -e py${PYTHON_ID}-all -- \
            --json-report --json-report-file=reports/universal-${{ matrix.os }}-${{ matrix.py }}.json \
            --junitxml=reports/universal-${{ matrix.os }}-${{ matrix.py }}.xml \
            --cov=pep249_dbapi \
            --cov-report=xml:reports/coverage-${{ matrix.os }}-${{ matrix.py }}.xml \
            --cov-report=html:reports/coverage-${{ matrix.os }}-${{ matrix.py }}-html
        working-directory: pep249_dbapi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        env:
          CODECOV_TOKEN: ${{ secrets.SNOW_CODECOV_TOKEN }}
        with:
          files: ./pep249_dbapi/reports/coverage-${{ matrix.os }}-${{ matrix.py }}.xml
          flags: python
          name: python-${{ matrix.os }}-py${{ matrix.py }}
          fail_ci_if_error: false

      - name: Upload test results as GitHub artifact
        uses: actions/upload-artifact@v4
        with:
          name: results-universal-${{ matrix.os }}-${{ matrix.py }}
          path: pep249_dbapi/reports/*-${{ matrix.os }}-${{ matrix.py }}.*

  # Integration tests only with reference connector (for comparison)
  pep249_tests_reference:
    needs: build_rust_core
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    continue-on-error: true  # Reference tests expected to fail due to behavioral differences
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.5.11"

      - name: Restore uv cache
        env:
          UV_CACHE_DIR: /tmp/.uv-cache
        uses: actions/cache@v4
        with:
          path: /tmp/.uv-cache
          key: uv-${{ runner.os }}-${{ env.REFERENCE_PYTHON_VERSION }}-${{ hashFiles('pep249_dbapi/uv.lock', 'pep249_dbapi/pyproject.toml', 'pep249_dbapi/tox.ini') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ env.REFERENCE_PYTHON_VERSION }}-
            uv-${{ runner.os }}-

      - name: Set up Python ${{ env.REFERENCE_PYTHON_VERSION }}
        run: uv python install ${{ env.REFERENCE_PYTHON_VERSION }}

      - name: Download Rust artifacts
        uses: actions/download-artifact@v4
        with:
          name: rust-core-library
          path: target/debug/

      - name: Decode secrets
        run: ./scripts/decode_secrets.sh
        env:
          PARAMETERS_SECRET: ${{ secrets.PARAMETERS_SECRET }}

      - name: Setup dependencies
        run: make setup
        working-directory: pep249_dbapi

      - name: Run reference integration tests
        env:
          CORE_PATH: ${{ github.workspace }}/target/debug/libsf_core.so
          PARAMETER_PATH: ${{ github.workspace }}/parameters.json
          REFERENCE_DRIVER_VERSION: ${{ env.PYTHON_REFERENCE_DRIVER_VERSION }}
        run: make ci-test-reference PYTHON_VERSION=${{ env.REFERENCE_PYTHON_VERSION }} OS_VERSION=${{ env.REFERENCE_OS_VERSION }}
        working-directory: pep249_dbapi

      - name: Upload test results as GitHub artifact
        uses: actions/upload-artifact@v4
        if: always()  # Upload test results even if tests fail (needed for comparison)
        with:
          name: results-reference-${{ env.REFERENCE_OS_VERSION }}-${{ env.REFERENCE_PYTHON_VERSION }}
          path: pep249_dbapi/reports/*-${{ env.REFERENCE_OS_VERSION }}-${{ env.REFERENCE_PYTHON_VERSION }}.*

  # Compare results between connectors
  pep249_compare_results:
    needs: [pep249_tests, pep249_tests_reference]
    if: always()  # Run comparison even if reference tests fail (we want to see the differences)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.5.11"

      - name: Download universal test results
        uses: actions/download-artifact@v4
        with: 
          name: results-universal-${{ env.REFERENCE_OS_VERSION }}-${{ env.REFERENCE_PYTHON_VERSION }}
          path: ${{ github.workspace }}/universal-results
      
      - name: Download reference test results
        uses: actions/download-artifact@v4
        with: 
          name: results-reference-${{ env.REFERENCE_OS_VERSION }}-${{ env.REFERENCE_PYTHON_VERSION }}
          path: ${{ github.workspace }}/reference-results

      - name: Setup dependencies
        run: make setup
        working-directory: pep249_dbapi

      - name: Compare integration test results
        env:
          UNIVERSAL_TEST_REPORTS_DIR: ${{ github.workspace }}/universal-results
          REFERENCE_TEST_REPORTS_DIR: ${{ github.workspace }}/reference-results
          FAIL_ON_REGRESSIONS: "0"   # set to "1" when ready to for a strong requirement on compliance with old driver
        run: |
          make ci-compare-artifacts PYTHON_VERSION=${{ env.REFERENCE_PYTHON_VERSION }} OS_VERSION=${{ env.REFERENCE_OS_VERSION }} | tee -a $GITHUB_STEP_SUMMARY
        working-directory: pep249_dbapi