name: Validate generated data

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  test-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install generator dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install brotli zstandard

      - name: Run all generator scripts
        run: |
          set -euo pipefail
          echo "Running generators in tests/test_data/test_data_generators -> tests/test_data/generated_test_data"
          for generator in tests/test_data/test_data_generators/*.py; do
            echo "Running generator"
            python "$generator" --out-dir tests/test_data/generated_test_data
          done

      - name: Check for uncommitted changes in generated test data
        run: |
          set -euo pipefail
          git status --porcelain=v1 -- tests/test_data/generated_test_data || true
          if [[ -n "$(git status --porcelain=v1 -- tests/test_data/generated_test_data)" ]]; then
            echo "Detected differences in tests/test_data/generated_test_data after regeneration." >&2
            echo "Please run the generator scripts locally and commit updated files." >&2
            echo
            git --no-pager diff -- tests/test_data/generated_test_data | sed -n '1,200p'
            exit 1
          fi
          echo "Generated test data matches repository."

  thrift:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate thrift
        uses: ./.github/actions/generate-thrift

      - name: Check thrift files are up-to-date
        run: git diff --exit-code
        
  proto:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate proto
        run: |
          ./scripts/generate_proto.sh
          cargo fmt --all --

      - name: Check proto files are up-to-date
        run: git diff --exit-code

